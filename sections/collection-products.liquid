{% render 'breadcrumbs' %}

<div class="collection-products">
  <div class="collection-products__container">
    {% if collection.products.size > 0 %}
      
      <!-- Pre-filter products into featured and non-featured arrays -->
      {% assign featured_product = null %}
      {% assign non_featured_count = 0 %}
      
      {% for product in collection.products %}
        {% if product.tags contains 'Featured' and featured_product == null %}
          {% assign featured_product = product %}
        {% else %}
          {% assign non_featured_count = non_featured_count | plus: 1 %}
        {% endif %}
      {% endfor %}
      
      <!-- Main Product Section -->
      {% if featured_product %}
        <div class="product-page">
          <div class="product-page__container">
            <div class="product-page__gallery">
              {% if featured_product.images.size > 0 %}
                <div class="product-gallery">
                  <div class="product-gallery__main">
                    <!-- Low-res placeholder -->
                    <img 
                      src="{{ featured_product.featured_image | image_url: width: 50, height: 50 }}" 
                      alt="{{ featured_product.title }}"
                      id="product-main-image-placeholder"
                      style="aspect-ratio: 1 / 1; filter: blur(10px); transition: opacity 0.3s ease;"
                    >
                    <!-- High-res main image -->
                    <img 
                      srcset="{{ featured_product.featured_image | image_url: width: 400, height: 400 }} 400w,
                              {{ featured_product.featured_image | image_url: width: 600, height: 600 }} 600w,
                              {{ featured_product.featured_image | image_url: width: 800, height: 800 }} 800w,
                              {{ featured_product.featured_image | image_url: width: 1200, height: 1200 }} 1200w"
                      sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 40vw"
                      src="{{ featured_product.featured_image | image_url: width: 600, height: 600 }}" 
                      alt="{{ featured_product.title }}"
                      id="product-main-image"
                      loading="eager"
                      style="aspect-ratio: 1 / 1; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.3s ease;"
                      onload="this.style.opacity='1'; document.getElementById('product-main-image-placeholder').style.opacity='0';"
                    >
                  </div>
                  {% if featured_product.images.size > 1 %}
                    <div class="product-gallery__thumbs">
                      {% for image in featured_product.images %}
                        <button 
                          class="product-gallery__thumb{% if forloop.first %} product-gallery__thumb--active{% endif %}"
                          data-image-url="{{ image | image_url: width: 800, height: 800 }}"
                          aria-label="View {{ featured_product.title }} image {{ forloop.index }}"
                        >
                          <img 
                            srcset="{{ image | image_url: width: 80, height: 80 }} 80w,
                                    {{ image | image_url: width: 120, height: 120 }} 120w,
                                    {{ image | image_url: width: 160, height: 160 }} 160w"
                            sizes="80px"
                            src="{{ image | image_url: width: 100, height: 100 }}" 
                            alt="{{ featured_product.title }}"
                            loading="lazy"
                            style="aspect-ratio: 1 / 1"
                          >
                        </button>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <div class="product-page__details">
              <h1 class="product-page__title">{{ featured_product.title }}</h1>
              
              <div class="product-page__price">
                {% if featured_product.compare_at_price > featured_product.price %}
                  <span class="product-page__price--sale">{{ featured_product.price | money }}</span>
                  <span class="product-page__price--compare">{{ featured_product.compare_at_price | money }}</span>
                {% else %}
                  <span class="product-page__price--regular">{{ featured_product.price | money }}</span>
                {% endif %}
              </div>

              {% if featured_product.description != blank %}
                <div class="product-description">
                  {{ featured_product.description }}
                </div>
              {% endif %}

              {% if featured_product.available %}
                <form class="product-page__form" data-product-form="{{ featured_product.id }}">
                  {% if featured_product.has_only_default_variant %}
                    <input type="hidden" name="id" value="{{ featured_product.selected_or_first_available_variant.id }}">
                    <div class="product-page__add-to-cart-row">
                      <div class="quantity-selector">
                        <button type="button" class="quantity-btn quantity-btn--minus" data-action="decrease">-</button>
                        <input type="number" id="quantity" name="quantity" value="1" min="1" class="quantity-input">
                        <button type="button" class="quantity-btn quantity-btn--plus" data-action="increase">+</button>
                      </div>
                      <button 
                        type="submit" 
                        class="button button--primary product-page__add-to-cart"
                        data-variant-id="{{ featured_product.selected_or_first_available_variant.id }}"
                        data-price="{{ featured_product.price }}"
                      >
                        <span>Add to Cart</span>
                        <span>&nbsp;•&nbsp;</span>
                        <span class="cart-price">{{ featured_product.price | money }}</span>
                      </button>
                    </div>
                  {% else %}
                    <div class="product-page__variants">
                      {% for option in featured_product.options_with_values %}
                        <div class="product-page__option">
                          <fieldset>
                            <legend class="product-page__option-label">{{ option.name }}</legend>
                            <div class="product-page__option-pills" role="radiogroup" aria-labelledby="option-{{ forloop.index0 }}-label" data-option-index="{{ forloop.index0 }}">
                            {% for value in option.values %}
                              {% assign variant_available = false %}
                              {% assign variant_image = null %}
                              {% for variant in featured_product.variants %}
                                {% if variant.option1 == value or variant.option2 == value or variant.option3 == value %}
                                  {% if variant.available %}
                                    {% assign variant_available = true %}
                                  {% endif %}
                                  {% if variant.featured_image %}
                                    {% assign variant_image = variant.featured_image %}
                                  {% endif %}
                                {% endif %}
                              {% endfor %}
                              <button 
                                type="button"
                                class="product-page__option-pill{% if option.selected_value == value %} product-page__option-pill--active{% endif %}"
                                data-option-value="{{ value | escape }}"
                                data-available="{{ variant_available }}"
                                data-variant-image="{% if variant_image %}{{ variant_image | image_url: width: 800, height: 800 }}{% endif %}"
                                role="radio"
                                aria-checked="{% if option.selected_value == value %}true{% else %}false{% endif %}"
                                aria-describedby="featured-option-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}-status"
                                {% unless variant_available %}disabled aria-disabled="true"{% endunless %}
                              >
                                {{ value }}
                                <span id="featured-option-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}-status" class="sr-only">
                                  {% if variant_available %}Available{% else %}Sold out{% endif %}
                                </span>
                              </button>
                            {% endfor %}
                            </div>
                            <input type="hidden" name="options[{{ option.name | escape }}]" value="{{ option.selected_value }}" data-option-index="{{ forloop.index0 }}">
                          </fieldset>
                        </div>
                      {% endfor %}
                    </div>
                    
                    <input type="hidden" name="id" value="{{ featured_product.selected_or_first_available_variant.id }}" id="variant-id">
                    
                    <script type="application/json" id="product-variants-json">
                      {
                        "variants": [
                          {% for variant in featured_product.variants %}
                          {
                            "id": {{ variant.id }},
                            "title": "{{ variant.title | escape }}",
                            "available": {{ variant.available }},
                            "price": {{ variant.price }},
                            "compare_at_price": {{ variant.compare_at_price | default: 0 }},
                            "option1": "{{ variant.option1 | escape }}",
                            "option2": "{{ variant.option2 | escape }}",
                            "option3": "{{ variant.option3 | escape }}"
                          }{% unless forloop.last %},{% endunless %}
                          {% endfor %}
                        ]
                      }
                    </script>
                    
                    <div class="product-page__add-to-cart-row">
                      <div class="quantity-selector">
                        <button type="button" class="quantity-btn quantity-btn--minus" data-action="decrease">-</button>
                        <input type="number" id="quantity" name="quantity" value="1" min="1" class="quantity-input">
                        <button type="button" class="quantity-btn quantity-btn--plus" data-action="increase">+</button>
                      </div>
                      <button 
                        type="submit" 
                        class="button button--primary product-page__add-to-cart"
                        data-product-id="{{ featured_product.id }}"
                        data-price="{{ featured_product.price }}"
                      >
                        <span>Add to Cart</span>
                        <span>&nbsp;•&nbsp;</span>
                        <span class="cart-price">{{ featured_product.price | money }}</span>
                      </button>
                    </div>
                  {% endif %}
                </form>
              {% else %}
                <div class="product-page__unavailable">
                  <span class="product-page__sold-out">Sold Out</span>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}

      <div class="merch-section__header">
        <h2 class="merch-section__title">Psst ... don't forget the merch!</h2>
        <div class="merch-section__divider">
          {% render 'divider'  %}
        </div>
      </div>

      <!-- Merch Section -->
      {% if non_featured_count > 0 %}
        <div>
          <div class="products-grid">
                        {% for product in collection.products %}
              {% unless product.tags contains 'Featured' %}
                {% render 'product-card', 
                  product: product, 
                  image_size: '400x400', 
                  show_description: false, 
                  card_class: 'product-card' 
                %}
              {% endunless %}
            {% endfor %}
          </div>
        </div>
      {% endif %}
      
      {% if paginate.pages > 1 %}
        <div class="pagination">
          {{ paginate | default_pagination }}
        </div>
      {% endif %}
      
    {% else %}
      <div class="collection-products__empty">
        <p>No products found in this collection.</p>
      </div>
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Collection Products",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 12,
      "label": "Products per page"
    },
    {
      "type": "select",
      "id": "products_per_row",
      "options": [
        {
          "value": "2",
          "label": "2 per row"
        },
        {
          "value": "3",
          "label": "3 per row"
        },
        {
          "value": "4",
          "label": "4 per row"
        }
      ],
      "default": "3",
      "label": "Products per row"
    }
  ]
}
{% endschema %} 