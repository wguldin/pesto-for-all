<div class="product-page">
  <div class="product-page__container">
    <div class="product-page__gallery">
      {% if product.images.size > 0 %}
        <div class="product-gallery">
          <div class="product-gallery__main">
            <!-- Low-res placeholder -->
            <img 
              src="{{ product.featured_image | image_url: width: 50, height: 50 }}" 
              alt="{{ product.title }}"
              id="product-main-image-placeholder"
              style="aspect-ratio: 1 / 1; filter: blur(10px); transition: opacity 0.3s ease;"
            >
            <!-- High-res main image -->
            <img 
              srcset="{{ product.featured_image | image_url: width: 400, height: 400 }} 400w,
                      {{ product.featured_image | image_url: width: 600, height: 600 }} 600w,
                      {{ product.featured_image | image_url: width: 800, height: 800 }} 800w,
                      {{ product.featured_image | image_url: width: 1200, height: 1200 }} 1200w"
              sizes="(max-width: 768px) 100vw, (max-width: 1024px) 50vw, 40vw"
              src="{{ product.featured_image | image_url: width: 600, height: 600 }}" 
              alt="{{ product.title }}"
              id="product-main-image"
              loading="eager"
              style="aspect-ratio: 1 / 1; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 0.3s ease;"
              onload="this.style.opacity='1'; document.getElementById('product-main-image-placeholder').style.opacity='0';"
            >
          </div>
          {% if product.images.size > 1 %}
            <div class="product-gallery__thumbs">
              {% for image in product.images %}
                <button 
                  class="product-gallery__thumb{% if forloop.first %} product-gallery__thumb--active{% endif %}"
                  data-image-url="{{ image | image_url: width: 800, height: 800 }}"
                  aria-label="View {{ product.title }} image {{ forloop.index }}"
                >
                  <img 
                    srcset="{{ image | image_url: width: 80, height: 80 }} 80w,
                            {{ image | image_url: width: 120, height: 120 }} 120w,
                            {{ image | image_url: width: 160, height: 160 }} 160w"
                    sizes="80px"
                    src="{{ image | image_url: width: 100, height: 100 }}" 
                    alt="{{ product.title }}"
                    loading="lazy"
                    style="aspect-ratio: 1 / 1"
                  >
                </button>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <div class="product-page__details">
      <h1 class="product-page__title">{{ product.title }}</h1>
      
      <div class="product-page__price">
        {% if product.compare_at_price > product.price %}
          <span class="product-page__price--sale">{{ product.price | money }}</span>
          <span class="product-page__price--compare">{{ product.compare_at_price | money }}</span>
        {% else %}
          <span class="product-page__price--regular">{{ product.price | money }}</span>
        {% endif %}
      </div>

      {% if product.description != blank %}
        <div class="product-description">
          {{ product.description }}
        </div>
      {% endif %}

      {% if product.available %}
        <form class="product-page__form" data-product-form="{{ product.id }}">
          {% if product.has_only_default_variant %}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
            <div class="product-page__add-to-cart-row">
              <div class="quantity-selector">
                <button type="button" class="quantity-btn quantity-btn--minus" data-action="decrease">-</button>
                <input type="number" id="quantity" name="quantity" value="1" min="1" class="quantity-input">
                <button type="button" class="quantity-btn quantity-btn--plus" data-action="increase">+</button>
              </div>
              <button 
                type="submit" 
                class="button button--primary product-page__add-to-cart"
                data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                data-price="{{ product.price }}"
              >
                <span>Add to Cart</span>
                <span>&nbsp;•&nbsp;</span>
                <span class="cart-price">{{ product.price | money }}</span>
              </button>
            </div>
          {% else %}
            <div class="product-page__variants">
              {% for option in product.options_with_values %}
                <div class="product-page__option">
                  <div class="product-page__option-pills" data-option-index="{{ forloop.index0 }}">
                    {% for value in option.values %}
                      {% assign variant_available = false %}
                      {% assign variant_image = null %}
                      {% for variant in product.variants %}
                        {% if variant.option1 == value or variant.option2 == value or variant.option3 == value %}
                          {% if variant.available %}
                            {% assign variant_available = true %}
                          {% endif %}
                          {% if variant.featured_image %}
                            {% assign variant_image = variant.featured_image %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                      <button 
                        type="button"
                        class="product-page__option-pill{% if option.selected_value == value %} product-page__option-pill--active{% endif %}"
                        data-option-value="{{ value | escape }}"
                        data-available="{{ variant_available }}"
                        data-variant-image="{% if variant_image %}{{ variant_image | image_url: width: 800, height: 800 }}{% endif %}"
                        {% unless variant_available %}disabled{% endunless %}
                      >
                        {{ value }}
                      </button>
                    {% endfor %}
                  </div>
                  <input type="hidden" name="options[{{ option.name | escape }}]" value="{{ option.selected_value }}" data-option-index="{{ forloop.index0 }}">
                </div>
              {% endfor %}
            </div>
            
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" id="variant-id">
            
            <script type="application/json" id="product-variants-json">
              {
                "variants": [
                  {% for variant in product.variants %}
                  {
                    "id": {{ variant.id }},
                    "title": "{{ variant.title | escape }}",
                    "available": {{ variant.available }},
                    "price": {{ variant.price }},
                    "compare_at_price": {{ variant.compare_at_price | default: 0 }},
                    "option1": "{{ variant.option1 | escape }}",
                    "option2": "{{ variant.option2 | escape }}",
                    "option3": "{{ variant.option3 | escape }}"
                  }{% unless forloop.last %},{% endunless %}
                  {% endfor %}
                ]
              }
            </script>
            
            <div class="product-page__add-to-cart-row">
              <div class="quantity-selector">
                <button type="button" class="quantity-btn quantity-btn--minus" data-action="decrease">-</button>
                <input type="number" id="quantity" name="quantity" value="1" min="1" class="quantity-input">
                <button type="button" class="quantity-btn quantity-btn--plus" data-action="increase">+</button>
              </div>
              <button 
                type="submit" 
                class="button button--primary product-page__add-to-cart"
                data-product-id="{{ product.id }}"
                data-price="{{ product.price }}"
              >
                <span>Add to Cart</span>
                <span>&nbsp;•&nbsp;</span>
                <span class="cart-price">{{ product.price | money }}</span>
              </button>
            </div>
          {% endif %}
        </form>
      {% else %}
        <div class="product-page__unavailable">
          <span class="product-page__sold-out">Sold Out</span>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Product",
  "settings": [
    {
      "type": "header",
      "content": "Product Page Settings"
    }
  ]
}
{% endschema %}